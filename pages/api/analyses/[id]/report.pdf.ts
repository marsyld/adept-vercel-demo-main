import type { NextApiRequest, NextApiResponse } from 'next'; import PDFDocument from 'pdfkit'; let store:any = (global as any)._BYUTICH_STORE || ((global as any)._BYUTICH_STORE = { rows: [] }); export default function handler(req:NextApiRequest,res:NextApiResponse){ if(!req.headers.authorization) return res.status(401).end(); const id=req.query.id as string; const row=store.rows.find((r:any)=>r.id===id); if(!row) return res.status(404).end(); res.setHeader('Content-Type','application/pdf'); res.setHeader('Content-Disposition',`inline; filename="report_${id}.pdf"`); const doc=new PDFDocument({margin:36}); doc.pipe(res); doc.fontSize(18).text('Отчёт анализа'); doc.moveDown(0.5); doc.fontSize(12).fillColor('#555').text('ID: '+id); doc.text('Статус: '+row.status); doc.moveDown(0.5); doc.fillColor('#000').text('Изображения:'); doc.fontSize(10).fillColor('#0a7').text('До: '+(row.assets?.normalized_url||'/demo/before.jpg')); doc.fillColor('#0a7').text('После: '+(row.assets?.after_simulation_url||'/demo/after.jpg')); doc.end(); }